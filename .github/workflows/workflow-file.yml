# 路径：.github/workflows/your-workflow-file.yml

name: Terraform Cloud

on:
  schedule:
    - cron: '0 3 * * *'  # 每天凌晨 3 点 (UTC)
  workflow_dispatch:      # 允许手动触发

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 允许 Action 提交代码

    env:
      # 保持和你现在一样的三个 Secrets
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      ABUSEIPDB_API_KEY: ${{ secrets.ABUSEIPDB_API_KEY }}

    steps:
      # 步骤 1: 检出代码
      - name: Checkout Code
        uses: actions/checkout@v4

      # 步骤 2: 运行 Python 脚本更新规则 (这部分完全不变)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml
      - name: Update ASN Rules from AbuseIPDB
        run: python update_abuseipdb_asns.py

      # 步骤 3: 拉取、提交并推送规则变更 (修正版)
      - name: Pull, Commit and Push if rules.yaml changed
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 首先，检查本地文件是否有变化，避免不必要的 git 操作
          # 我们通过 git status 来判断 rules.yaml 是否被修改
          if ! git status --porcelain | grep -q "rules.yaml"; then
            echo "No changes to WAF rules. Skipping commit."
            exit 0
          fi

          # 1. 先拉取远程的最新更改
          git pull --rebase

          # 2. 添加本地的更改
          git add rules.yaml
          
          # 3. 提交更改
          git commit -m "chore(waf): Auto-update WAF rules with latest ASN list"
          
          # 4. 推送所有更改
          git push



      # 步骤 4: 设置 Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # 步骤 5: Terraform 初始化
      # 它会自动读取 backend.tf 并连接到 Terraform Cloud
      - name: Terraform Init
        run: terraform init

      # 步骤 6: 解决之前域名被删除导致的状态不一致问题
      # 这个命令现在会直接操作云端的状态文件
      - name: Remove stale resource from state if it exists
        run: terraform state rm 'cloudflare_ruleset.waf_ruleset["20241108.xyz"]' || true

      # 步骤 7: Terraform 部署
      - name: Terraform Apply
        run: terraform apply -auto-approve
